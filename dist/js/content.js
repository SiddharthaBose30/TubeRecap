/*! For license information please see content.js.LICENSE.txt */
(()=>{"use strict";var e=function(t,n){return e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var n in t)Object.prototype.hasOwnProperty.call(t,n)&&(e[n]=t[n])},e(t,n)};var t=/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/i,n="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36,gzip(gfe)",r=function(t){function n(e){return t.call(this,"[YoutubeTranscript] ðŸš¨ "+e)||this}return function(t,n){function r(){this.constructor=t}e(t,n),t.prototype=null===n?Object.create(n):(r.prototype=n.prototype,new r)}(n,t),n}(Error),o=function(){function e(){}return e.fetchTranscript=function(e,t){return o=this,i=void 0,c=function(){var o,i,s,c,a;return function(e,t){var n,r,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;s;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,r=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!((o=(o=s.trys).length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}(this,(function(u){switch(u.label){case 0:o=this.retrieveVideoId(e),u.label=1;case 1:return u.trys.push([1,7,,8]),[4,fetch("https://www.youtube.com/watch?v="+o,{headers:{"User-Agent":n}})];case 2:return[4,u.sent().text()];case 3:return i=u.sent(),(s=i.split('"INNERTUBE_API_KEY":"')[1].split('"')[0])&&s.length>0?[4,fetch("https://www.youtube.com/youtubei/v1/get_transcript?key="+s,{method:"POST",body:JSON.stringify(this.generateRequest(i,t)),headers:{"Content-Type":"application/json","User-Agent":n}})]:[3,6];case 4:return[4,u.sent().json()];case 5:if((c=u.sent()).responseContext){if(!c.actions)throw new Error("Transcript is disabled on this video");return[2,c.actions[0].updateEngagementPanelAction.content.transcriptRenderer.body.transcriptBodyRenderer.cueGroups.map((function(e){return{text:e.transcriptCueGroupRenderer.cues[0].transcriptCueRenderer.cue.simpleText,duration:parseInt(e.transcriptCueGroupRenderer.cues[0].transcriptCueRenderer.durationMs),offset:parseInt(e.transcriptCueGroupRenderer.cues[0].transcriptCueRenderer.startOffsetMs)}}))]}u.label=6;case 6:return[3,8];case 7:throw a=u.sent(),new r(a);case 8:return[2]}}))},new((s=void 0)||(s=Promise))((function(e,t){function n(e){try{a(c.next(e))}catch(e){t(e)}}function r(e){try{a(c.throw(e))}catch(e){t(e)}}function a(t){var o;t.done?e(t.value):(o=t.value,o instanceof s?o:new s((function(e){e(o)}))).then(n,r)}a((c=c.apply(o,i||[])).next())}));var o,i,s,c},e.generateRequest=function(e,t){var n,r,o,i,s=null===(n=e.split('"serializedShareEntity":"')[1])||void 0===n?void 0:n.split('"')[0],c=null===(r=e.split('"VISITOR_DATA":"')[1])||void 0===r?void 0:r.split('"')[0],a=null===(o=e.split('"sessionId":"')[1])||void 0===o?void 0:o.split('"')[0],u=null===(i=null==e?void 0:e.split('"clickTrackingParams":"')[1])||void 0===i?void 0:i.split('"')[0];return{context:{client:{hl:(null==t?void 0:t.lang)||"en",gl:(null==t?void 0:t.country)||"US",visitorData:c,userAgent:"Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_4) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/85.0.4183.83 Safari/537.36,gzip(gfe)",clientName:"WEB",clientVersion:"2.20200925.01.00",osName:"Macintosh",osVersion:"10_15_4",browserName:"Chrome",browserVersion:"85.0f.4183.83",screenWidthPoints:1440,screenHeightPoints:770,screenPixelDensity:2,utcOffsetMinutes:120,userInterfaceTheme:"USER_INTERFACE_THEME_LIGHT",connectionType:"CONN_CELLULAR_3G"},request:{sessionId:a,internalExperimentFlags:[],consistencyTokenJars:[]},user:{},clientScreenNonce:this.generateNonce(),clickTracking:{clickTrackingParams:u}},params:s}},e.generateNonce=function(){for(var e=Math.random().toString(),t="ABCDEFGHIJKLMOPQRSTUVWXYZabcdefghjijklmnopqrstuvwxyz0123456789",n=t+"-_.",r=[],o=0;o<e.length-1;o++)r.push(e[o].charCodeAt(o));for(var i,s,c,a,u,l="",p=0;p<r.length;)a=(u=r[p])>>2,u=(3&u)<<4|(i=p+1<r.length?r[p+1]:0)>>4,i=(15&i)<<2|(c=(s=p+2<r.length)?r[p+2]:0)>>6,c&=63,s||(c=64)||(i=64),l+=n[a]+n[u]+n[i]+n[c],p+=3;return l},e.retrieveVideoId=function(e){if(11===e.length)return e;var n=e.match(t);if(n&&n.length)return n[1];throw new r("Impossible to retrieve Youtube video ID.")},e}();chrome.runtime.onMessage.addListener((function(e,t,n){var r;"get_transcript_data"===e.message&&function(e,t){void 0===t&&(t=3);var n=function(){return new Promise((function(r,i){o.fetchTranscript(e).then((function(e){e?r(e):(console.log("Transcript not found, retrying..."),t>0?setTimeout((function(){return r(n())}),1e3):i("Max retries reached. Transcript not found."))})).catch((function(e){i("Error fetching transcript:"+e)}))}))};return n()}(null===(r=null===window||void 0===window?void 0:window.location)||void 0===r?void 0:r.href).then((function(e){chrome.runtime.sendMessage({message:"transcript_data",data:e},(function(e){console.log("Transcript Data sent to Popup.HTML")}))})).catch((function(e){console.error(e)}))}))})();